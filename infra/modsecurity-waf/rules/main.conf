# ModSecurity Core Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Audit Logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# Debug log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Default action for blocking
SecDefaultAction "phase:1,log,auditlog,deny,status:403"
SecDefaultAction "phase:2,log,auditlog,deny,status:403"

# === SECURITY RULES ===

# Rule 1: Block XSS
SecRule ARGS|ARGS_NAMES|REQUEST_HEADERS|XML:/* "@rx (?i)(<script|javascript:|onerror=|onload=|<iframe)" \
    "id:1001,phase:2,deny,status:403,t:none,t:urlDecodeUni,msg:'XSS Attack Blocked',logdata:'%{MATCHED_VAR}',severity:'CRITICAL',tag:'attack-xss'"

# Rule 2: Block SQL Injection
# Rule 2: Block SQL Injection (improved)
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(union|select|insert|delete|drop|update|--|;|'|\"|\*|=)" \
    "id:1002,phase:2,deny,status:403,t:none,t:urlDecodeUni,msg:'SQL Injection Blocked',severity:'CRITICAL',tag:'attack-sqli'"

# Rule 3: Block Path Traversal
SecRule REQUEST_URI "@rx (?:\.\.\/|\.\.\\|etc\/passwd|windows\/system)" \
    "id:1003,phase:1,deny,status:403,t:none,t:urlDecodeUni,msg:'Path Traversal Blocked',severity:'CRITICAL'"

# Rule 4: Block Scanners
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(nikto|sqlmap|nmap|masscan|acunetix|nessus|burp|metasploit)" \
    "id:1004,phase:1,deny,status:403,t:none,t:lowercase,msg:'Scanner Blocked',severity:'WARNING'"

# Rule 5: Block Command Injection
SecRule ARGS|REQUEST_BODY "@rx (?i)(;|\||`|\$\(|<\(|>\()" \
    "id:1005,phase:2,deny,status:403,t:none,t:urlDecodeUni,msg:'Command Injection Blocked',severity:'CRITICAL'"

# Rule 6: Rate Limiting (Allow detection, let Nginx handle it)
SecAction "id:1006,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR},setvar:ip.req=+1,expirevar:ip.req=60"

# Rule 7: Block RCE
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i)(eval\(|base64_decode|exec\(|system\()" \
    "id:1008,phase:2,deny,status:403,t:none,t:urlDecodeUni,msg:'RCE Blocked',severity:'CRITICAL'"

# Rule 8: Block Dangerous Uploads
SecRule FILES "@rx (?i)\.(php|asp|jsp|sh|exe|dll)$" \
    "id:1009,phase:2,deny,status:403,msg:'Dangerous Upload Blocked',severity:'CRITICAL'"
# ============================================================================
# DDoS PROTECTION BY ModSecurity WAF
# ============================================================================

# Khởi tạo counter cho mỗi IP
SecAction \
    "id:5001,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.request_count=+1,\
    expirevar:ip.request_count=10"

# LEVEL 1: Warning khi vượt 30 requests trong 10 giây
SecRule IP:REQUEST_COUNT "@gt 30" \
    "id:5002,\
    phase:1,\
    pass,\
    nolog,\
    setvar:ip.ddos_warning=1,\
    msg:'DDoS Warning: High request rate from IP'"

# LEVEL 2: Block khi vượt 50 requests trong 10 giây
SecRule IP:REQUEST_COUNT "@gt 50" \
    "id:5003,\
    phase:1,\
    deny,\
    status:403,\
    msg:'ModSecurity DDoS Protection: Request rate too high',\
    logdata:'IP: %{REMOTE_ADDR} - Request Count: %{IP.REQUEST_COUNT}',\
    severity:'WARNING',\
    tag:'ddos-protection',\
    setvar:ip.ddos_blocked=1"

# LEVEL 3: Ban IP trong 60 giây nếu vượt 100 requests
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:5004,\
    phase:1,\
    deny,\
    status:403,\
    msg:'ModSecurity: IP Banned for DDoS attack',\
    logdata:'IP: %{REMOTE_ADDR} banned for 60 seconds',\
    severity:'CRITICAL',\
    tag:'ddos-ban',\
    setvar:ip.banned=1,\
    expirevar:ip.banned=60"

# LEVEL 4: Chặn IP đã bị ban
SecRule IP:BANNED "@eq 1" \
    "id:5005,\
    phase:1,\
    deny,\
    status:403,\
    msg:'ModSecurity: IP is temporarily banned',\
    severity:'CRITICAL',\
    tag:'ddos-banned-ip'"
