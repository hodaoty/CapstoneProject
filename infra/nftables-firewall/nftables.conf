#!/usr/sbin/nft -f
# =============================================================================
# NFTABLES DDoS PROTECTION CONFIGURATION
# =============================================================================
# Rate Limit: 10 requests/second (burst 15)
# Violation tracking: 30 seconds window
# Auto-ban trigger: IP in violation set gets banned on next violation
# Ban duration: 1 hour
# =============================================================================

define FRONTEND_IP = 172.20.0.30
define API_GATEWAY_IP = 172.20.0.20

table inet filter {
    # ===== BLACKLIST SETS =====
    
    # Permanent ban list (manual)
    set permanent_ban {
        type ipv4_addr
        comment "Manually banned IPs - no expiry"
    }
    
    # Auto-ban list (DDoS detected)
    set ddos_blacklist {
        type ipv4_addr
        size 65535
        flags dynamic, timeout
        timeout 1h
        comment "Auto-banned IPs - 1 hour timeout"
    }
    
    # Violation tracker - IPs that exceeded rate limit
    # If an IP appears here and violates again within 30s → auto-ban
    set rate_limit_violations {
        type ipv4_addr
        size 10000
        flags dynamic, timeout
        timeout 30s
        comment "IPs that violated rate limit - 30s tracking window"
    }
    
    # ===== COUNTERS FOR MONITORING =====
    counter normal_traffic {
        comment "Packets accepted normally"
    }
    counter rate_limited {
        comment "Packets dropped due to rate limit"
    }
    counter auto_banned {
        comment "Packets when IP was auto-banned"
    }
    counter ddos_blocked {
        comment "Packets blocked from banned IPs"
    }
    
    # ===== FORWARD CHAIN (Main traffic filtering) =====
    chain forward {
        type filter hook forward priority 0; policy accept;
        
        # ─────────────────────────────────────────────────────────────
        # STEP 1: Check blacklists FIRST (most restrictive)
        # ─────────────────────────────────────────────────────────────
        
        # Permanent ban - no logging needed, just drop
        ip saddr @permanent_ban counter name "ddos_blocked" drop
        
        # Auto-banned IPs - log and drop
        ip saddr @ddos_blacklist \
            log prefix "[DDOS-BLOCKED] " \
            counter name "ddos_blocked" \
            drop
        
        # ─────────────────────────────────────────────────────────────
        # STEP 2: Allow established connections (performance)
        # ─────────────────────────────────────────────────────────────
        ct state established,related accept
        
        # ─────────────────────────────────────────────────────────────
        # STEP 3: Rate limiting for new connections to Frontend
        # ─────────────────────────────────────────────────────────────
        
        # Check if IP already has a violation record
        # If yes → this is a repeat offender → AUTO-BAN
        ip daddr $FRONTEND_IP tcp dport 8080 ct state new \
            ip saddr @rate_limit_violations \
            update @ddos_blacklist { ip saddr timeout 1h } \
            log prefix "[AUTO-BAN] " \
            counter name "auto_banned" \
            drop
        
        # Rate limit: 10 requests/second with burst of 15
        # This is reasonable for normal browsing
        ip daddr $FRONTEND_IP tcp dport 8080 ct state new \
            limit rate 10/second burst 15 packets \
            counter name "normal_traffic" \
            accept
        
        # If we reach here → rate limit exceeded
        # Add IP to violation tracker and drop packet
        ip daddr $FRONTEND_IP tcp dport 8080 ct state new \
            add @rate_limit_violations { ip saddr timeout 30s } \
            log prefix "[RATE-LIMITED] " \
            counter name "rate_limited" \
            drop
        
        # ─────────────────────────────────────────────────────────────
        # STEP 4: Rate limiting for API Gateway (same logic)
        # ─────────────────────────────────────────────────────────────
        
        ip daddr $API_GATEWAY_IP tcp dport 8080 ct state new \
            ip saddr @rate_limit_violations \
            update @ddos_blacklist { ip saddr timeout 1h } \
            log prefix "[AUTO-BAN-API] " \
            counter name "auto_banned" \
            drop
        
        ip daddr $API_GATEWAY_IP tcp dport 8080 ct state new \
            limit rate 10/second burst 15 packets \
            counter name "normal_traffic" \
            accept
        
        ip daddr $API_GATEWAY_IP tcp dport 8080 ct state new \
            add @rate_limit_violations { ip saddr timeout 30s } \
            log prefix "[RATE-LIMITED-API] " \
            counter name "rate_limited" \
            drop
    }
    
    # ===== INPUT CHAIN (Traffic to firewall itself) =====
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Loopback
        iif lo accept
        
        # Established connections
        ct state established,related accept
        
        # SSH access
        tcp dport 22 accept
        
        # Docker internal communication
        tcp dport { 80, 8888 } accept
        
        # ICMP (ping)
        icmp type echo-request accept
    }
    
    # ===== OUTPUT CHAIN =====
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# ===== NAT TABLE =====
table inet nat {
    chain prerouting {
        type nat hook prerouting priority -100; policy accept;
        
        # Port 80 → Frontend
        tcp dport 80 dnat ip to $FRONTEND_IP:8080
        
        # Port 8888 → API Gateway
        tcp dport 8888 dnat ip to $API_GATEWAY_IP:8080
    }
    
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        masquerade
    }
}
